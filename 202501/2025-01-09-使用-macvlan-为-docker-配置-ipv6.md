# 使用 macvlan 为 Docker 配置 IPv6
- URL: https://blog.xm.mk/posts/73f9/
- Added At: 2025-01-09 08:38:24
- [Link To Text](2025-01-09-使用-macvlan-为-docker-配置-ipv6_raw.md)

## TL;DR
本文介绍了如何为 Docker 容器配置 IPv6 支持，重点推荐使用 macvlan 方法，能够自动获取公网 IPv6 地址。文章详细说明了配置步骤、IPv6 地址类型、解决容器与宿主机通信问题的方法，以及如何持久化配置。macvlan 方法灵活且安全，适用于多种场景。

## Summary
1. **Docker IPv6 支持背景**：
   - Docker 容器默认不支持 IPv6，但在某些地区（如无公网 IPv4 的情况下），IPv6 可以提供更好的连接性和公网访问能力。
   - 使用 qBittorrent 等工具时，IPv6 地址尤为重要。

2. **配置 IPv6 的三种方法**：
   - **HOST 模式**：直接使用主机网络，但存在严重的安全风险。
   - **官方 IPv6 支持**：仅能获取私网 IPv6 地址，配置公网 IPv6 地址较为复杂。
   - **macvlan 方法**：为 Docker 创建支持 IPv6 的网络，自动从上级路由获取公网 IPv6 地址。

3. **IPv6 地址类型**：
   - **Loopback 地址**：`::1`，类似于 IPv4 的 `127.0.0.1`。
   - **链路本地地址**：`fe80::/10`，仅在区域内有效。
   - **唯一区域地址（ULA）**：私有地址空间，用于本地通信。
   - **全局地址**：公网地址，以 `2XXX:` 开头。
   - **本地站点地址**：`fec0::/10`，已被废弃。

4. **macvlan 配置步骤**：
   - **创建网络**：
     - 使用 `docker network create` 命令创建支持 IPv6 的 macvlan 网络。
     - 配置 IPv4 和 IPv6 的子网及网关。
     - 指定出口网卡（如 `ovs_eth0`）。
   - **为容器应用网络**：
     - 使用 `docker run` 或 `docker-compose` 为容器指定网络。
     - 无需配置端口映射。

5. **解决容器与宿主机通信问题**：
   - **默认限制**：macvlan 模式下，宿主机与容器无法直接通信。
   - **解决方案**：
     - 创建虚拟接口并配置路由，使宿主机通过虚拟接口访问容器。
     - 修改路由表，将容器 IP 指向虚拟接口。

6. **持久化配置**：
   - **Systemd 配置**：
     - 创建开机启动脚本，确保 macvlan 配置在重启后自动生效。
     - 使用 Systemd 服务单元文件管理 macvlan 配置。
   - **群晖 DSM 配置**：
     - 在 `/usr/local/etc/rc.d` 中写入启动脚本，或通过控制面板设置开机脚本。

7. **参考资料**：
   - 包括 ArchWiki 的 IPv6 文档、Docker 官方文档以及其他技术博客。

8. **总结**：
   - 通过 macvlan 为 Docker 配置 IPv6 是一种灵活且安全的方式，能够充分利用 IPv6 的公网地址空间。
   - 配置过程涉及网络创建、容器应用网络、解决通信问题以及持久化配置，适用于多种场景。
